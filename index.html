<!DOCTYPE html>
<html>


<script>

function setElementId(elements, countryCode) {
  for (var i = 0; i < elements.length; i++) {
    var element = elements[i];
    element.id = element.id + "_" + countryCode;
  }
}

function selcountry(countryCode, country) {
    const cc = document.getElementById(countryCode);
    if (cc.checked ==  true) {
        const template = document.getElementById("template");
        const container = document.getElementById("container");
        const firstClone = template.content.cloneNode(true);

        // Set the country name
        var elements = firstClone.querySelectorAll("#country");
        for (var i = 0; i < elements.length; i++) {
             var element = elements[i];
             element.textContent = country;
        }

        // Set the id for the country container from just cid to cid_{countryCode}, e.g. cid_nz
        var elements = firstClone.querySelectorAll("#cid");
        setElementId(elements, countryCode);

        var elements = firstClone.querySelectorAll("#daterange");
        setElementId(elements, countryCode);


        var elements = firstClone.querySelectorAll("#dates");
        for (var i = 0; i < elements.length; i++) {
            var element = elements[i];
            element.setAttribute('onclick', "uiDateVsYears('" + countryCode + "')") ;
        }


        var elements = firstClone.querySelectorAll("#daterow");
        setElementId(elements, countryCode);


        var elements = firstClone.querySelectorAll("#years");
        setElementId(elements, countryCode);


        container.appendChild(firstClone);
    } else {

        const cc = document.getElementById("cid_" + countryCode);
        cc.remove();
        

    }    
}


function uiDateVsYears(cc) {
    
    const el = document.getElementById("daterange_" + cc);
    el.hidden = !el.hidden;

}


function calcYears(e) {
    const cc = e.target.parentElement.parentElement.id.split("_")[1];
    console.log('Country is ' + cc);    

    var days = 0;

    // FIXME:
    
    // Iterate through each pair of dates
    // get the values, calculate the duration in days
    // if positive value - add those to convert them to years
    // maybe: highlight something were it cannot be added
    var elements = container.querySelectorAll(".datefrom");
    for (var i = 0; i < elements.length; i++) {
        var element = elements[i];

        if(element.id.includes("datefrom_")) {        
            var idp = element.id.split("_")[2];

            dateto = document.getElementById("dateto_" + cc + "_" + idp);

            console.log("idp: " + idp);
            console.log(element.value);
            console.log(dateto.value);


            var differenceMs = new Date(dateto.value) - new Date(element.value);
            var differenceDays = Math.floor(differenceMs / (1000 * 60 * 60 * 24));
            console.log('The difference in days is: ' + differenceDays);
            var differenceYears = Math.floor(differenceDays / 365);
            console.log('The difference in years is: ' + differenceYears);

            
            if (differenceDays > 0) {
                days += differenceDays;
            } else {
                // TODO: mark this row as invalid
            }

        }
    }

    var totalYears = Math.floor(days / 365);
    
    yearsElement = document.getElementById("years_" + cc);
    yearsElement.value = totalYears;

}



function addMore(e) {
    const cc = e.target.parentElement.id.split("_")[1];
    console.log('Add more: Country is ' + cc);

    const template = document.getElementById("template_daterow");

    const container = e.target.parentElement;


    var elements = container.querySelectorAll("#daterow_" + cc);
    var daterow_element = elements[0];

    const firstClone = template.content.cloneNode(true);

    var n = 0;
    var elements = container.querySelectorAll(".datefrom");
    for (var i = 0; i < elements.length; i++) {
        var element = elements[i];

        if(element.id.includes("datefrom_")) {
        
            var idp = element.id.split("_")[2];
            if (idp > n) {
                n = idp;
            }
        }
    }

    n++;

    var elements = firstClone.querySelectorAll("#datefrom");
    setElementId(elements, cc + "_" +n);

    var elements = firstClone.querySelectorAll("#dateto");
    setElementId(elements, cc + "_" +n);

      

    daterow_element.appendChild(firstClone);

}


</script>


Which of those countries have you lived in?<p>
<input id="nz" type="checkbox" onclick="selcountry('nz', 'New Zealand');">NZ
<input id="au" type="checkbox" onclick="selcountry('au', 'Australia');">Australia
<input id="cok" type="checkbox" onclick="selcountry('cok', 'Cook Islands');">Cook Islands
<input id="ni" type="checkbox" onclick="selcountry('ni', 'Niue');">Niue
<input id="tk" type="checkbox" onclick="selcountry('tk', 'Tokelau');">Tokelau

<p>
Which of these countries have you contributed to?<p>
<input id="dk" type="checkbox" onclick="selcountry('dk', 'Denmark');">Denmark
<input id="kor" type="checkbox" onclick="selcountry('kor', 'South Korea');">South Korea
<input id="ie" type="checkbox" onclick="selcountry('ie', 'Ireland');">Ireland
<input id="uk" type="checkbox" onclick="selcountry('uk', 'United Kingdom');">United Kingdom

<template id="template">
<p id="cid">I lived in <span id="country">Australia</span> for <input id="years" type="number" size="2" min="0" max="99"> years.  
    <a id="dates" href="#">Specify dates instead</a>.<br>
    <span id="daterow"></span>
    <a href="#" id="more" onclick="addMore(event)">Add more</a>
    </span>
</template>


<template id="template_daterow">
    <span id="daterange"> From: <input type="date" id="datefrom" class="datefrom" onchange="calcYears(event)"> to <input type="date" id="dateto" class="dateto" onchange="calcYears(event)"><br>
</template>

<div id="container"></div>



</html>
